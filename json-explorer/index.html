<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/adbox-tiny.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AdTech Toolbox</title>
    
    <!-- Direktes Laden des CMP - direkt im HTML ohne Verzögerung -->
    <script>
      // Global CMP settings
      window.UC_UI_SETTINGS = {
        settingsId: 'AVmhdo98bxlHZn',
        baseUrl: 'https://web.cmp.usercentrics.eu',
        version: 'latest',
        tcfEnabled: true,
        displayOnlyForEU: false,
        tcfRespectExcludeCountries: true,
        // Explizit erlaubte Domänen für Usercentrics
        allowedDomains: [
          'adtech-toolbox.com',
          'staging.adtech-toolbox.com',
          'localhost'
        ]
      };
      
      // Flag ob manuelles Triggern benötigt wird
      window.NEEDS_MANUAL_CMP_TRIGGER = (window.location.hostname.includes('staging') || window.location.hostname === 'localhost');
      
      // Debug-Hilfsfunktion
      window.logCMPStatus = function(origin) {
        console.log('[CMP Status ' + origin + ']:', 
          'UC_UI:', window.UC_UI ? 'Available' : 'Not available',
          'isInitialized:', window.UC_UI?.isInitialized ? (window.UC_UI.isInitialized() ? 'Yes' : 'No') : 'Function missing'
        );
      };
      
      // Force-Anzeige des CMP
      window.forceShowCMP = function() {
        try {
          if (window.UC_UI) {
            console.log('Forcing CMP to show');
            window.UC_UI.showFirstLayer();
            return true;
          }
        } catch(e) {
          console.error('Error showing CMP:', e);
        }
        return false;
      };
    </script>
    
    <!-- Inline-Loader für Usercentrics, um sicherzustellen, dass es sofort geladen wird -->
    <script>
      (function() {
        var script = document.createElement('script');
        script.id = 'usercentrics-cmp';
        script.src = window.UC_UI_SETTINGS.baseUrl + '/ui/loader.js';
        script.setAttribute('data-settings-id', window.UC_UI_SETTINGS.settingsId);
        if (window.UC_UI_SETTINGS.tcfEnabled) {
          script.setAttribute('data-tcf-enabled', '');
        }
        
        script.onload = function() {
          console.log('Usercentrics script loaded');
          // Kurze Verzögerung für die Initialisierung
          setTimeout(function() {
            window.logCMPStatus('after script load');
            
            if (window.NEEDS_MANUAL_CMP_TRIGGER) {
              window.forceShowCMP();
            }
          }, 500);
        };
        
        // Direkt am Anfang einfügen, um sicherzustellen, dass es zuerst geladen wird
        var firstScript = document.getElementsByTagName('script')[0];
        firstScript.parentNode.insertBefore(script, firstScript);
      })();
    </script>
    
    <!-- Dynamic meta robots tag -->
    <script>
      // Check if this is staging or has no_ads parameter
      const isStaging = window.location.hostname.includes('staging');
      const hasNoAdsParam = window.location.search.includes('no_ads');
      
      if (isStaging || hasNoAdsParam) {
        // Create a meta tag to prevent indexing
        const metaRobots = document.createElement('meta');
        metaRobots.name = 'robots';
        metaRobots.content = 'noindex, nofollow';
        document.head.appendChild(metaRobots);
        console.log('Added noindex meta tag');
      }
    </script>
    
    <!-- Erweiterte Event-Erfassung für CMP -->
    <script>
      // Standard Usercentrics Event
      window.addEventListener('UC_UI_INITIALIZED', function() {
        console.log('UC_UI_INITIALIZED event received');
        window.logCMPStatus('from UC_UI_INITIALIZED event');
      });
      
      // Backup für den Fall, dass das Event nicht ausgelöst wird
      window.addEventListener('load', function() {
        console.log('Window load complete');
        
        setTimeout(function() {
          window.logCMPStatus('from window.load after 1000ms');
          
          // Letzter Versuch, das CMP anzuzeigen, wenn nötig
          if (window.NEEDS_MANUAL_CMP_TRIGGER && !window.UC_UI?.isInitialized?.()) {
            console.log('Last attempt to show CMP');
            window.forceShowCMP();
          }
        }, 1000);
      });
    </script>
    
    <!-- Prebid.js -->
    <script src="/prebid.js" async></script>
    
    <!-- GPT - mit async, damit es nicht blockiert -->
    <script src="https://securepubads.g.doubleclick.net/tag/js/gpt.js" async></script>
    <script src="/gpt.js" async></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
