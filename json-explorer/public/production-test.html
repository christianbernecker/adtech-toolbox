<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdTech Toolbox - Produktionstest</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 1rem;
        }
        .logo {
            display: flex;
            align-items: center;
        }
        .logo-icon {
            width: 40px;
            height: 40px;
            background-color: #4285f4;
            border-radius: 4px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
        }
        .test-badge {
            background-color: #dc3545;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: bold;
        }
        .ads-container {
            display: flex;
            margin-top: 2rem;
            min-height: 600px;
        }
        .sidebar {
            width: 300px;
            margin-right: 2rem;
        }
        .main-content {
            flex: 1;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        h1 {
            margin-top: 0;
            color: #212529;
        }
        h2 {
            margin-top: 0;
            color: #495057;
            font-size: 1.25rem;
        }
        .test-ad {
            padding: 1rem;
            border: 1px dashed #dee2e6;
            border-radius: 4px;
            color: white;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }
        .test-ad-left {
            width: 160px;
            height: 600px;
            background: linear-gradient(135deg, #4285f4, #34a853);
        }
        .test-ad-right {
            width: 300px;
            height: 250px;
            background: linear-gradient(135deg, #ea4335, #fbbc05);
        }
        .test-ad-banner {
            width: 100%;
            height: 90px;
            background: linear-gradient(90deg, #fbbc05, #ea4335);
            margin-top: 2rem;
        }
        .status {
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        .status-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        footer {
            margin-top: 4rem;
            padding-top: 2rem;
            border-top: 1px solid #dee2e6;
            text-align: center;
            color: #6c757d;
        }
        .debug-info {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        button {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.5rem;
        }
        button:hover {
            background-color: #3367d6;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">AT</div>
                <h1>AdTech Toolbox</h1>
            </div>
            <div class="test-badge">PRODUKTIONSTEST</div>
        </header>
        
        <div class="card">
            <h2>CMP Status</h2>
            <div id="cmp-status" class="status status-warning">CMP wird geladen...</div>
            
            <div id="consent-services"></div>
            
            <h3>Marketing Consent</h3>
            <div id="marketing-consent" class="status status-warning">Wird geprüft...</div>
            
            <button onclick="acceptAllCookies()">Alle akzeptieren</button>
            <button onclick="rejectAllCookies()">Alle ablehnen</button>
            <button onclick="openCmpSettings()">Einstellungen öffnen</button>
        </div>
        
        <div class="card">
            <h2>Werbeintegration</h2>
            <div id="ad-status" class="status status-warning">Google Publisher Tag wird geladen...</div>
            
            <div class="debug-info" id="debug-output">Debug-Informationen werden geladen...</div>
        </div>
        
        <div class="ads-container">
            <div class="sidebar">
                <div class="card">
                    <h2>Linke Spalte (160x600)</h2>
                    <div id="div-gpt-ad-left-status" class="status status-warning">Anzeige wird geladen...</div>
                    
                    <!-- Platzhalter für Testanzeige -->
                    <div id="div-gpt-ad-left-test" class="test-ad test-ad-left">
                        <div>TEST AD</div>
                        <div>160x600</div>
                    </div>
                    
                    <!-- Echter Ad Slot -->
                    <div id="div-gpt-ad-left"></div>
                </div>
            </div>
            
            <div class="main-content">
                <div class="card">
                    <h2>Rechte Spalte (300x250)</h2>
                    <div id="div-gpt-ad-right-status" class="status status-warning">Anzeige wird geladen...</div>
                    
                    <!-- Platzhalter für Testanzeige -->
                    <div id="div-gpt-ad-right-test" class="test-ad test-ad-right">
                        <div>TEST AD</div>
                        <div>300x250</div>
                    </div>
                    
                    <!-- Echter Ad Slot -->
                    <div id="div-gpt-ad-right"></div>
                </div>
                
                <!-- Banner unten -->
                <div class="card">
                    <h2>Banner unten (728x90)</h2>
                    <div id="div-gpt-ad-bottom-status" class="status status-warning">Anzeige wird geladen...</div>
                    
                    <!-- Platzhalter für Testanzeige -->
                    <div id="div-gpt-ad-bottom-test" class="test-ad test-ad-banner">
                        <div>TEST AD 728x90</div>
                    </div>
                    
                    <!-- Echter Ad Slot -->
                    <div id="div-gpt-ad-bottom"></div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>&copy; 2024 AdTech Toolbox - Produktionstest</p>
        </footer>
    </div>

    <!-- Debug-Skript - VOR allen anderen Skripten laden -->
    <script>
        // Debug-Log-Funktion
        const debugLog = [];
        function log(message) {
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const logMessage = `[${timestamp}] ${message}`;
            debugLog.push(logMessage);
            
            const debugOutput = document.getElementById('debug-output');
            if (debugOutput) {
                debugOutput.textContent = debugLog.join('\n');
                debugOutput.scrollTop = debugOutput.scrollHeight;
            }
            
            console.log(logMessage);
        }

        // Dokumentieren, dass die Seite geladen wurde
        log('Seite wird geladen...');
        
        // Prüfen, ob window verfügbar ist
        if (window) {
            log('Window-Objekt ist verfügbar');
        } else {
            log('FEHLER: Window-Objekt ist NICHT verfügbar');
        }
        
        // Document Ready State überwachen
        document.addEventListener('readystatechange', function() {
            log(`Document Ready State: ${document.readyState}`);
        });
        
        // Load-Event abfangen
        window.addEventListener('load', function() {
            log('Window load-Event ausgelöst');
        });
        
        // Fehlermeldungen abfangen
        window.addEventListener('error', function(event) {
            log(`FEHLER: ${event.message} bei ${event.filename}:${event.lineno}`);
        });
    </script>
    
    <!-- Usercentrics CMP -->
    <script id="usercentrics-cmp" 
            data-settings-id="AVmhdo98bxlHZn" 
            data-tcf-enabled 
            src="https://web.cmp.usercentrics.eu/ui/loader.js">
    </script>
    
    <!-- Google Publisher Tag -->
    <script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"></script>
    
    <!-- Haupt-Skript -->
    <script>
        // Grundlegende Variablen
        window.googletag = window.googletag || { cmd: [] };
        let cmpLoaded = false;
        let adsInitialized = false;
        
        // CMP-Funktionen
        function acceptAllCookies() {
            log('Benutzer klickte auf "Alle akzeptieren"');
            if (window.UC_UI && window.UC_UI.acceptAllConsents) {
                log('UC_UI.acceptAllConsents() wird aufgerufen');
                window.UC_UI.acceptAllConsents();
                setTimeout(updateCmpStatus, 1000);
                setTimeout(initializeAds, 1500);
            } else {
                log('FEHLER: UC_UI ist nicht verfügbar oder hat keine acceptAllConsents-Methode');
            }
        }
        
        function rejectAllCookies() {
            log('Benutzer klickte auf "Alle ablehnen"');
            if (window.UC_UI && window.UC_UI.rejectAllConsents) {
                log('UC_UI.rejectAllConsents() wird aufgerufen');
                window.UC_UI.rejectAllConsents();
                setTimeout(updateCmpStatus, 1000);
            } else {
                log('FEHLER: UC_UI ist nicht verfügbar oder hat keine rejectAllConsents-Methode');
            }
        }
        
        function openCmpSettings() {
            log('Benutzer klickte auf "Einstellungen öffnen"');
            if (window.UC_UI && window.UC_UI.showSecondLayer) {
                log('UC_UI.showSecondLayer() wird aufgerufen');
                window.UC_UI.showSecondLayer();
            } else {
                log('FEHLER: UC_UI ist nicht verfügbar oder hat keine showSecondLayer-Methode');
            }
        }
        
        // Debug-Funktion, um CMP-Status anzuzeigen
        function updateCmpStatus() {
            log('CMP-Status wird aktualisiert');
            const cmpStatusEl = document.getElementById('cmp-status');
            const consentServicesEl = document.getElementById('consent-services');
            const marketingConsentEl = document.getElementById('marketing-consent');
            
            try {
                if (window.UC_UI && typeof window.UC_UI.isInitialized === 'function') {
                    const isInitialized = window.UC_UI.isInitialized();
                    log(`CMP initialisiert: ${isInitialized}`);
                    
                    if (isInitialized) {
                        cmpStatusEl.textContent = 'CMP geladen und initialisiert';
                        cmpStatusEl.className = 'status status-success';
                        cmpLoaded = true;
                        
                        // CMP-Services prüfen
                        try {
                            const services = window.UC_UI.getServicesBaseInfo();
                            log(`CMP-Services gefunden: ${services.length}`);
                            
                            // Consent-Services-Element leeren
                            consentServicesEl.innerHTML = '';
                            
                            let hasMarketingConsent = false;
                            
                            services.forEach(service => {
                                log(`Service: ${service.name}, ID: ${service.id}, Consent: ${service.consent.status}`);
                                
                                if (service.id === 'BJz7qNsdj-7' && service.consent.status === true) {
                                    hasMarketingConsent = true;
                                }
                                
                                const serviceEl = document.createElement('div');
                                serviceEl.className = service.consent.status ? 'status status-success' : 'status status-warning';
                                serviceEl.textContent = `${service.name}: ${service.consent.status ? 'Zugestimmt' : 'Abgelehnt'}`;
                                consentServicesEl.appendChild(serviceEl);
                            });
                            
                            marketingConsentEl.textContent = hasMarketingConsent ? 'Erteilt' : 'Nicht erteilt';
                            marketingConsentEl.className = hasMarketingConsent ? 'status status-success' : 'status status-warning';
                            
                            // Wenn Marketing-Consent vorhanden ist und Ads noch nicht initialisiert wurden, Ads initialisieren
                            if (hasMarketingConsent && !adsInitialized) {
                                log('Marketing-Consent vorhanden, Werbeanzeigen werden initialisiert');
                                initializeAds();
                            }
                        } catch (e) {
                            log(`FEHLER beim Abrufen der Services: ${e.message}`);
                            consentServicesEl.innerHTML = `<div class="status status-danger">Fehler beim Abrufen der Services: ${e.message}</div>`;
                        }
                    } else {
                        cmpStatusEl.textContent = 'CMP wird geladen...';
                        cmpStatusEl.className = 'status status-warning';
                    }
                } else {
                    log('UC_UI ist nicht verfügbar oder hat keine isInitialized-Methode');
                    cmpStatusEl.textContent = 'CMP wird geladen...';
                    cmpStatusEl.className = 'status status-warning';
                }
            } catch (e) {
                log(`FEHLER beim Aktualisieren des CMP-Status: ${e.message}`);
                cmpStatusEl.textContent = `CMP-Fehler: ${e.message}`;
                cmpStatusEl.className = 'status status-danger';
            }
        }
        
        // Ad-Status aktualisieren
        function updateAdStatus() {
            const adStatusEl = document.getElementById('ad-status');
            
            try {
                if (window.googletag && window.googletag.apiReady) {
                    log('Google Publisher Tag ist geladen und bereit');
                    adStatusEl.textContent = 'Google Publisher Tag geladen';
                    adStatusEl.className = 'status status-success';
                    
                    // Wenn noch nicht initialisiert, auf CMP warten oder initialisieren
                    if (!adsInitialized) {
                        if (cmpLoaded) {
                            try {
                                const services = window.UC_UI.getServicesBaseInfo();
                                const marketingService = services.find(s => s.id === 'BJz7qNsdj-7');
                                
                                if (marketingService && marketingService.consent.status) {
                                    log('Marketing-Consent ist bereits vorhanden, Werbeanzeigen werden initialisiert');
                                    initializeAds();
                                } else {
                                    log('Warten auf Marketing-Consent');
                                    adStatusEl.textContent = 'Warten auf Marketing-Consent';
                                    adStatusEl.className = 'status status-warning';
                                }
                            } catch (e) {
                                log(`FEHLER beim Prüfen des Marketing-Consents: ${e.message}`);
                            }
                        }
                    }
                } else {
                    log('Google Publisher Tag wird noch geladen');
                    adStatusEl.textContent = 'Google Publisher Tag wird geladen...';
                    adStatusEl.className = 'status status-warning';
                }
            } catch (e) {
                log(`FEHLER beim Aktualisieren des Ad-Status: ${e.message}`);
                adStatusEl.textContent = `Ad-Fehler: ${e.message}`;
                adStatusEl.className = 'status status-danger';
            }
        }
        
        // Werbeanzeigen initialisieren
        function initializeAds() {
            if (adsInitialized) {
                log('Werbeanzeigen wurden bereits initialisiert');
                return;
            }
            
            log('Initialisiere Werbeanzeigen...');
            
            try {
                googletag.cmd.push(function() {
                    log('GPT cmd wird ausgeführt');
                    
                    try {
                        // Werbe-Slots definieren
                        googletag.defineSlot('/19968336/adtech-toolbox-left', [160, 600], 'div-gpt-ad-left')
                            .addService(googletag.pubads())
                            .setTargeting('test', ['true']);
                        log('Linker Werbeslot definiert');
                        
                        googletag.defineSlot('/19968336/adtech-toolbox-right', [300, 250], 'div-gpt-ad-right')
                            .addService(googletag.pubads())
                            .setTargeting('test', ['true']);
                        log('Rechter Werbeslot definiert');
                        
                        googletag.defineSlot('/19968336/adtech-toolbox-bottom', [728, 90], 'div-gpt-ad-bottom')
                            .addService(googletag.pubads())
                            .setTargeting('test', ['true']);
                        log('Unterer Werbeslot definiert');
                        
                        // Targeting-Parameter setzen
                        googletag.pubads().setTargeting('page', ['test']);
                        
                        // GPT konfigurieren
                        googletag.pubads().enableSingleRequest();
                        googletag.pubads().collapseEmptyDivs();
                        
                        // Listener für render-complete Events
                        googletag.pubads().addEventListener('slotRenderEnded', function(event) {
                            const slot = event.slot;
                            const id = slot.getSlotElementId();
                            const isEmpty = event.isEmpty;
                            
                            log(`Slot Render Event für ${id}: ${isEmpty ? 'leer' : 'gefüllt'}`);
                            
                            // Status-Updates anzeigen
                            const statusEl = document.getElementById(`${id}-status`);
                            if (statusEl) {
                                if (isEmpty) {
                                    statusEl.textContent = 'Keine Anzeige ausgeliefert';
                                    statusEl.className = 'status status-warning';
                                } else {
                                    statusEl.textContent = 'Anzeige erfolgreich ausgeliefert';
                                    statusEl.className = 'status status-success';
                                    
                                    // Test-Anzeige ausblenden, wenn echte Anzeige geladen
                                    const testAd = document.getElementById(`${id}-test`);
                                    if (testAd) {
                                        testAd.style.display = 'none';
                                    }
                                }
                            }
                        });
                        
                        // GPT initialisieren
                        log('Rufe googletag.enableServices() auf');
                        googletag.enableServices();
                        
                        // Anzeigen anfordern
                        log('Fordere Anzeigen an');
                        googletag.display('div-gpt-ad-left');
                        googletag.display('div-gpt-ad-right');
                        googletag.display('div-gpt-ad-bottom');
                        
                        adsInitialized = true;
                        log('Werbeanzeigen wurden initialisiert');
                    } catch (e) {
                        log(`FEHLER beim Initialisieren der GPT-Anzeigen: ${e.message}`);
                    }
                });
            } catch (e) {
                log(`FEHLER beim Initialisieren der Werbeanzeigen: ${e.message}`);
            }
        }
        
        // Regelmäßige Statusaktualisierungen
        window.addEventListener('load', function() {
            log('Window load-Event ausgelöst, starte Statusprüfungen');
            
            // Sofort prüfen
            updateCmpStatus();
            updateAdStatus();
            
            // Periodisch prüfen
            setInterval(updateCmpStatus, 5000);
            setInterval(updateAdStatus, 5000);
            
            // Prüfen, ob DOM-Elemente vorhanden sind
            const leftAdSlot = document.getElementById('div-gpt-ad-left');
            const rightAdSlot = document.getElementById('div-gpt-ad-right');
            const bottomAdSlot = document.getElementById('div-gpt-ad-bottom');
            
            log(`DOM-Elemente für Ad-Slots: Links ${leftAdSlot ? 'vorhanden' : 'FEHLT'}, Rechts ${rightAdSlot ? 'vorhanden' : 'FEHLT'}, Unten ${bottomAdSlot ? 'vorhanden' : 'FEHLT'}`);
        });
        
        // UC-Funktionalitäten prüfen, sobald UC geladen ist
        document.addEventListener('ucEvent', function(event) {
            log(`Usercentrics Event empfangen: ${event.detail.event}`);
            
            if (event.detail && event.detail.event === 'consent_status') {
                log('Consent-Status hat sich geändert');
                updateCmpStatus();
                
                setTimeout(function() {
                    try {
                        const services = window.UC_UI.getServicesBaseInfo();
                        const marketingService = services.find(s => s.id === 'BJz7qNsdj-7');
                        
                        if (marketingService && marketingService.consent.status && !adsInitialized) {
                            log('Marketing-Consent erhalten, initialisiere Werbeanzeigen');
                            initializeAds();
                        }
                    } catch (e) {
                        log(`FEHLER beim Verarbeiten des Consent-Events: ${e.message}`);
                    }
                }, 500);
            }
        });
    </script>
</body>
</html> 